# TASK-024: Project Initialization Script

**Priority**: High  
**Estimated**: 4 hours  
**Dependencies**: TASK-001 (プロジェクト構造)

## Prerequisites

- Node.js CLI 開発の基礎
- AWS SDK の知識
- 対話式 UI ライブラリ（inquirer等）の理解

## Reference Implementation

- Primary: `@docs/impl/workflow/project-init.md` - 初期化スクリプト実装
- Security: `@docs/impl/security/best-practices.md` - Secrets Manager

## Acceptance Criteria

- [ ] `npm run init` で対話式セットアップが開始される
- [ ] 必要な AWS リソースの存在確認が行われる（project-init.md Section 3）
- [ ] .env ファイルが自動生成される（Secrets Manager 優先）
- [ ] オプション機能の選択が可能（非同期ジョブ、スケジュール）
- [ ] 初期デプロイが自動実行される
- [ ] セットアップ完了まで 30 分以内
- [ ] エラー時のロールバック機能

## Detailed Implementation

### Main Script
```typescript
// scripts/init.ts - project-init.md Section 4
import { program } from 'commander';
import inquirer from 'inquirer';
import { SecretsManagerClient } from '@aws-sdk/client-secrets-manager';
import chalk from 'chalk';
import ora from 'ora';

interface InitOptions {
  projectName: string;
  awsProfile?: string;
  region: string;
  features: {
    asyncJobs: boolean;
    scheduledTasks: boolean;
    monitoring: boolean;
  };
}

class ProjectInitializer {
  private secrets: SecretsManagerClient;
  
  async run() {
    console.log(chalk.blue('🚀 サーバーレステンプレート初期化'));
    
    // 1. 前提条件チェック
    await this.checkPrerequisites();
    
    // 2. 対話式設定
    const options = await this.promptConfiguration();
    
    // 3. AWS 接続確認
    await this.verifyAWSAccess(options);
    
    // 4. 環境設定生成
    await this.generateEnvironment(options);
    
    // 5. 依存関係インストール
    await this.installDependencies();
    
    // 6. 初期リソース作成
    await this.createInitialResources(options);
    
    // 7. サンプルデータ投入
    if (await this.confirmSampleData()) {
      await this.seedSampleData();
    }
    
    console.log(chalk.green('✅ セットアップ完了！'));
  }
```

### Interactive Configuration
```typescript
  private async promptConfiguration(): Promise<InitOptions> {
    const answers = await inquirer.prompt([
      {
        type: 'input',
        name: 'projectName',
        message: 'プロジェクト名:',
        default: 'my-serverless-app',
        validate: (input) => /^[a-z0-9-]+$/.test(input),
      },
      {
        type: 'list',
        name: 'region',
        message: 'AWS リージョン:',
        choices: ['ap-northeast-1', 'us-east-1', 'eu-west-1'],
        default: 'ap-northeast-1',
      },
      {
        type: 'checkbox',
        name: 'features',
        message: 'オプション機能を選択:',
        choices: [
          { name: '非同期ジョブ処理', value: 'asyncJobs' },
          { name: 'スケジュールタスク', value: 'scheduledTasks' },
          { name: '監視ダッシュボード', value: 'monitoring' },
        ],
      },
    ]);
    
    return this.parseAnswers(answers);
  }
```

### Environment Generation
```typescript
  private async generateEnvironment(options: InitOptions) {
    const spinner = ora('環境設定を生成中...').start();
    
    try {
      // Secrets Manager 優先
      const secrets = await this.fetchSecrets(options);
      
      const envContent = `
# Generated by init script
PROJECT_NAME=${options.projectName}
AWS_REGION=${options.region}
STAGE=dev

# Features
ENABLE_ASYNC_JOBS=${options.features.asyncJobs}
ENABLE_SCHEDULED_TASKS=${options.features.scheduledTasks}

# Secrets from AWS Secrets Manager
GOOGLE_CLIENT_ID=${secrets.googleClientId || 'SET_IN_SECRETS_MANAGER'}
GOOGLE_CLIENT_SECRET=${secrets.googleClientSecret || 'SET_IN_SECRETS_MANAGER'}
JWT_SECRET=${secrets.jwtSecret || this.generateJWTSecret()}
`;
      
      await fs.writeFile('.env', envContent);
      spinner.succeed('環境設定を生成しました');
    } catch (error) {
      spinner.fail('環境設定の生成に失敗しました');
      throw error;
    }
  }
}
```

### Rollback Support
```typescript
private async rollback(error: Error) {
  console.error(chalk.red('❌ エラーが発生しました:', error.message));
  
  const { confirmRollback } = await inquirer.prompt([
    {
      type: 'confirm',
      name: 'confirmRollback',
      message: 'ロールバックしますか？',
      default: true,
    },
  ]);
  
  if (confirmRollback) {
    // 作成したリソースを削除
    await this.cleanup();
  }
}
```

## Quality Gates

- Setup time: < 30 minutes
- Error handling: 100% coverage
- Rollback success rate: 100%
- User experience: Clear progress indicators

## Verification Steps

```bash
# スクリプトの実行
npm run init

# 生成されたファイルの確認
cat .env
cat .env.local

# AWS リソースの確認
aws dynamodb list-tables
aws s3 ls

# 機能フラグの確認
grep ENABLE_ASYNC_JOBS .env

# 再実行時の冪等性確認
npm run init # 既存リソースを検出して スキップすることを確認
```

## Output

- ユーザーフレンドリーな初期化スクリプト
- 30分以内の完全セットアップ
- エラー時の安全なロールバック

## Progress

- [ ] Started
- [ ] Implementation complete
- [ ] Verified
- [ ] Documented